<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JeyKeys - Kids Typing Adventure</title>
    <style>
        :root {
            --primary: #22c55e;
            --secondary: #10b981;
            --accent: #a3e635;
            --bg-color: #064e3b;
            --text-color: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);

            /* Finger Colors */
            --f-pinky: #f87171;
            --f-ring: #fbbf24;
            --f-middle: #34d399;
            --f-index: #60a5fa;
            --f-thumb: #a78bfa;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Nunito', sans-serif;
            background: radial-gradient(circle at center, #065f46 0%, #022c22 100%);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* --- UI Components --- */
        .container {
            width: 100%;
            max-width: 1000px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px var(--primary);
        }

        .btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            padding: 10px 20px;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-small {
            padding: 5px 15px;
            font-size: 0.9rem;
        }

        .btn-back {
            background: #4b5563;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        .screen.game-mode {
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Main Menu - New Layout (Index-3 Style) */
        .menu-section {
            width: 100%;
            max-width: 800px;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--accent);
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid var(--glass-border);
            padding-bottom: 10px;
            display: inline-block;
            width: 100%;
        }

        /* Grid for Fingers (Top) */
        .drills-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .drill-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }

        .drill-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        .drill-card h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .drill-card p {
            margin: 5px 0 0;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Grid for Adventure (Bottom) */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .level-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--secondary);
        }

        .level-num {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 2px;
            color: var(--accent);
        }

        .level-name {
            font-size: 0.7rem;
            opacity: 0.9;
            line-height: 1.1;
        }

        .stars {
            margin-top: 2px;
            font-size: 0.7rem;
            color: #444;
        }

        .star.filled {
            color: #fbbf24;
            text-shadow: 0 0 5px #fbbf24;
        }

        /* Game Area (Index-1 Base) */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 30px;
            border-radius: 30px;
        }

        .display-area {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 30px;
            width: 100%;
            box-shadow: 0 0 20px rgba(217, 70, 239, 0.5);
            position: relative;
            text-align: left;
            line-height: 1.5;
            font-family: 'Courier New', monospace;
            overflow-y: hidden;
            height: auto;
            min-height: 150px;
        }

        .char {
            transition: color 0.1s;
            border-radius: 4px;
            display: inline-block;
            min-width: 0.6em;
            text-align: center;
        }

        .char.space-char {
            border-bottom: 2px solid #ccc;
            border-radius: 0;
            opacity: 0.5;
        }

        .char.enter-char {
            color: var(--primary);
            font-size: 0.8em;
            width: auto;
            margin-left: 5px;
        }

        .char.enter-char::after {
            content: "‚Üµ";
        }

        .char.correct {
            color: #16a34a;
            background: transparent;
        }

        .char.incorrect {
            color: #dc2626;
            text-decoration: underline;
            background: #fee2e2;
        }

        .char.current {
            background: var(--primary);
            color: white;
            border-radius: 4px;
            animation: none;
            border-bottom: none;
        }

        .char.pending {
            color: #9ca3af;
        }

        @keyframes pulse {
            50% {
                border-color: transparent;
            }
        }

        /* --- Virtual Keyboard --- */
        .keyboard {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transform: scale(0.9);
        }

        .row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .key {
            width: 45px;
            height: 45px;
            background: #374151;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #1f2937;
            position: relative;
            font-size: 1rem;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .key.active {
            transform: translateY(4px);
            box-shadow: none !important;
            filter: brightness(1.2);
        }

        .key.target {
            animation: targetPulse 1s infinite;
            border: 2px solid white;
            z-index: 10;
        }

        @keyframes targetPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }

        /* Finger Color Coding */
        .f-pinky {
            border-bottom: 4px solid var(--f-pinky);
        }

        .f-ring {
            border-bottom: 4px solid var(--f-ring);
        }

        .f-middle {
            border-bottom: 4px solid var(--f-middle);
        }

        .f-index {
            border-bottom: 4px solid var(--f-index);
        }

        .f-thumb {
            border-bottom: 4px solid var(--f-thumb);
        }

        /* Special Keys */
        .k-space {
            width: 250px;
        }

        .k-shift {
            width: 100px;
        }

        .k-back {
            width: 80px;
            font-size: 0.8rem;
        }

        .k-tab {
            width: 70px;
            font-size: 0.8rem;
        }

        .k-caps {
            width: 80px;
            font-size: 0.8rem;
        }

        .k-enter {
            width: 90px;
            font-size: 0.8rem;
        }

        /* Hand Indicators */
        .hand-indicators {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            padding: 0 20px;
        }

        .hand {
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .hand.active {
            opacity: 1;
            text-shadow: 0 0 10px white;
        }

        /* Modal / Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #4c1d95, #8b5cf6);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--accent);
            max-width: 400px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            font-size: 2.5rem;
            margin-top: 0;
            color: #fbbf24;
        }

        .score-big {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            animation: fall linear forwards;
            pointer-events: none;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 200;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>‚ú® JeyKeys - Kids Typing Adventure</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span
                    style="font-size: 0.9rem; font-weight: bold; color: #fbbf24; text-shadow: 0 0 5px rgba(0,0,0,0.5);">High
                    Score: <span id="menu-highscore">0</span></span>
                <button class="btn btn-small" style="background:linear-gradient(45deg, #fbbf24, #f59e0b)"
                    onclick="app.startMode('game')">‚≠ê Star Rush</button>
                <button id="mute-btn" class="btn btn-small">üîä Sound On</button>
            </div>
        </header>

        <!-- Main Menu -->
        <div id="menu-screen" class="screen active">

            <!-- Section 1: Finger Drills (Index-3 Style Order: Top) -->
            <div class="menu-section">
                <div class="section-title">üñê Finger Drills</div>
                <div class="drills-grid" id="drills-container">
                    <!-- Javascript will populate -->
                </div>
            </div>

            <!-- Section 2: Adventure Levels -->
            <div class="menu-section">
                <div class="section-title">üåà Adventure Levels</div>
                <div class="levels-grid" id="levels-container">
                    <!-- Javascript will populate -->
                </div>
            </div>

        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen game-mode">
            <div class="stats-bar">
                <div>Time: <span id="timer">00:00</span></div>
                <div>Score: <span id="score">0</span></div>
                <div>Level: <span id="level-name">--</span></div>
                <button class="btn btn-small btn-back" onclick="app.showMenu()">Exit</button>
            </div>

            <div id="display-area" class="display-area">
                Click "Start" to begin...
            </div>

            <div class="hand-indicators">
                <div id="hand-left" class="hand">LEFT HAND <span id="finger-name-left"
                        style="color: var(--accent);"></span></div>
                <div id="hand-right" class="hand"><span id="finger-name-right" style="color: var(--accent);"></span>
                    RIGHT HAND</div>
            </div>

            <div class="keyboard" id="keyboard">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="result-modal" class="overlay">
        <div class="modal">
            <h2 id="result-title">Good Job!</h2>
            <p>Your Score:</p>
            <div class="score-big" id="result-score">100</div>
            <p id="result-wpm" style="font-size: 1.2rem; margin: -10px 0 15px 0; opacity: 0.8">WPM: 0</p>
            <div id="result-stars" style="font-size: 2rem; margin-bottom: 20px;"></div>
            <p id="result-msg">Keep practicing!</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" onclick="app.showMenu()">Menu</button>
                <button class="btn" onclick="app.retry()">Retry</button>
                <button id="btn-next-level" class="btn"
                    style="background: linear-gradient(45deg, #10b981, #059669); display: none;">Next ‚û°</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        class TypingApp {
            constructor() {
                this.soundEnabled = true;
                this.currentMode = null; // 'drill', 'adventure', 'game'
                this.currentLevelIndex = 0;
                this.score = 0;
                this.timer = 0;
                this.timerInterval = null;
                this.text = "";
                this.currentIndex = 0;
                this.isPlaying = false;

                // --- DATA SOURCES ---

                // From Index-1: Drills
                this.drills = [
                    { name: "Home Row", chars: "asdfjkl;", content: "asdf jkl;\nsad dad lad\nflask fall" },
                    { name: "Top Row", chars: "qwertyuiop", content: "qwerty uiop\npot top tree\nquiet port" },
                    { name: "Bottom Row", chars: "zxcvbnm,./", content: "zxcv bnm,./\nvan cab man\nzone calm" },
                    { name: "Capitals", chars: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", content: "Hello World\nMagic Star\nMoon Light" }
                ];

                // Adventure Levels - themed word groups for progressive typing practice
                this.adventureLevels = [
                    { id: 1, name: "Colors", icon: "üé®", words: ["red", "blue", "green", "yellow", "purple", "orange", "pink", "black", "white", "brown", "gray", "gold", "silver", "violet", "coral", "teal", "navy", "cream"] },
                    { id: 2, name: "Pets", icon: "üêæ", words: ["cat", "dog", "hamster", "bunny", "goldfish", "parrot", "turtle", "kitten", "puppy", "guinea pig", "canary", "ferret", "pony", "gecko", "gerbil", "rabbit"] },
                    { id: 3, name: "Zoo Animals", icon: "ü¶Å", words: ["lion", "tiger", "elephant", "giraffe", "zebra", "panda", "penguin", "monkey", "hippo", "koala", "gorilla", "kangaroo", "cheetah", "flamingo", "rhino", "otter", "sloth", "peacock"] },
                    { id: 4, name: "Fruits", icon: "üçé", words: ["apple", "banana", "grape", "mango", "peach", "cherry", "strawberry", "orange", "lemon", "melon", "berry", "pear", "plum", "kiwi", "coconut", "papaya", "fig", "lime"] },
                    { id: 5, name: "Vegetables", icon: "ü•ï", words: ["carrot", "potato", "tomato", "spinach", "broccoli", "pepper", "onion", "corn", "celery", "lettuce", "pumpkin", "peas", "beans", "garlic", "cabbage", "beet", "radish", "zucchini"] },
                    { id: 6, name: "Kid Fav Food", icon: "üçï", words: ["pizza", "burger", "pasta", "taco", "nuggets", "pancake", "waffle", "hotdog", "noodles", "sandwich", "pretzel", "popcorn", "nachos", "sushi", "toast", "bagel", "fries", "rice"] },
                    { id: 7, name: "Desserts", icon: "üç∞", words: ["cake", "cookie", "donut", "candy", "brownie", "muffin", "pudding", "cupcake", "waffle", "pie", "fudge", "sundae", "toffee", "sorbet", "eclair", "truffle", "parfait", "gelato"] },
                    { id: 8, name: "Flowers", icon: "üå∏", words: ["rose", "daisy", "tulip", "lily", "sunflower", "orchid", "violet", "poppy", "peony", "iris", "lotus", "jasmine", "dahlia", "lilac", "pansy", "daffodil", "marigold", "bluebell"] },
                    { id: 9, name: "Plants", icon: "üåø", words: ["fern", "cactus", "bamboo", "ivy", "moss", "shrub", "vine", "herb", "palm", "clover", "willow", "maple", "cedar", "birch", "oak", "pine", "spruce", "sage"] },
                    { id: 10, name: "Vehicles", icon: "üöó", words: ["car", "bus", "truck", "train", "plane", "boat", "bike", "rocket", "scooter", "taxi", "van", "tram", "ferry", "subway", "canoe", "kayak", "yacht", "helicopter"] },
                    { id: 11, name: "Art Supplies", icon: "üñçÔ∏è", words: ["crayon", "pencil", "brush", "canvas", "marker", "chalk", "paint", "easel", "pastel", "palette", "sketch", "eraser", "ink", "glitter", "stencil", "clay", "charcoal", "glue"] },
                    { id: 12, name: "Countries", icon: "üåç", words: ["Japan", "India", "Brazil", "France", "Canada", "Kenya", "Egypt", "Mexico", "Spain", "Italy", "China", "Peru", "Chile", "Norway", "Greece", "Cuba", "Nepal", "Ghana"] },
                    { id: 13, name: "Capital Cities", icon: "üèõÔ∏è", words: ["Tokyo", "Paris", "London", "Cairo", "Delhi", "Lima", "Rome", "Oslo", "Athens", "Havana", "Ottawa", "Seoul", "Berlin", "Madrid", "Dublin", "Nairobi", "Accra", "Hanoi"] },
                    { id: 14, name: "School Things", icon: "üéí", words: ["school", "paper", "ruler", "book", "desk", "chair", "class", "board", "lunch", "recess", "math", "music", "teacher", "locker", "homework", "backpack", "notebook", "science"] },
                    { id: 15, name: "Family", icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", words: ["friend", "family", "mother", "father", "sister", "brother", "cousin", "grandma", "grandpa", "baby", "uncle", "aunt", "parent", "nephew", "niece"] },
                    { id: 16, name: "Nature", icon: "üå≥", words: ["forest", "jungle", "ocean", "river", "cloud", "storm", "rain", "snow", "wind", "mountain", "valley", "canyon", "island", "glacier", "volcano", "meadow", "lake", "waterfall"] },
                    { id: 17, name: "Verbs", icon: "üèÉ", words: ["playing", "jumping", "running", "walking", "eating", "sleeping", "reading", "writing", "drawing", "dancing", "singing", "swimming", "flying", "talking", "listening", "helping"] },
                    { id: 18, name: "Adventure", icon: "üè∞", words: ["happiness", "rainbow", "butterfly", "dinosaur", "astronaut", "treasure", "pirate", "wizard", "dragon", "magic", "castle", "unicorn", "hero", "fairy", "explore", "planet", "rocket"] },
                    { id: 19, name: "Kid Book Titles", icon: "üìö", words: ["Cat in the Hat", "Green Eggs and Ham", "The Very Hungry Caterpillar", "Goodnight Moon", "Where the Wild Things Are", "The Giving Tree", "Curious George", "Madeline", "Corduroy", "Chicka Chicka Boom Boom", "Brown Bear Brown Bear", "If You Give a Mouse a Cookie", "The Lorax", "Frog and Toad", "Clifford the Big Red Dog", "Amelia Bedelia"] },
                    { id: 20, name: "Phrases", icon: "üí¨", words: ["red rose", "big elephant", "fast car", "blue sky", "hot pizza", "green fern", "cute puppy", "yummy cake", "cool train", "pink tulip", "fresh carrot", "sunny day", "tall giraffe", "sweet cherry", "happy parrot", "bright star"] }
                ];

                this.simpleWords = ["cat", "dog", "sun", "bat", "run", "sky", "fox", "cup", "hat", "pen", "box", "key", "ant", "bus", "car", "map", "top", "pop", "log", "pig", "cow", "rat", "bug", "bee", "toy", "bed", "fan", "pan", "pot", "lid", "red", "blue"];

                // Visual Keyboard Layout
                this.keyLayout = [
                    [
                        ["`", "Backquote", "f-pinky", "L"], ["1", "Digit1", "f-pinky", "L"], ["2", "Digit2", "f-ring", "L"], ["3", "Digit3", "f-middle", "L"], ["4", "Digit4", "f-index", "L"], ["5", "Digit5", "f-index", "L"],
                        ["6", "Digit6", "f-index", "R"], ["7", "Digit7", "f-index", "R"], ["8", "Digit8", "f-middle", "R"], ["9", "Digit9", "f-ring", "R"], ["0", "Digit0", "f-pinky", "R"], ["-", "Minus", "f-pinky", "R"], ["=", "Equal", "f-pinky", "R"], ["Backspace", "Backspace", "k-back f-pinky", "R"]
                    ],
                    [
                        ["Tab", "Tab", "k-tab f-pinky", "L"], ["Q", "KeyQ", "f-pinky", "L"], ["W", "KeyW", "f-ring", "L"], ["E", "KeyE", "f-middle", "L"], ["R", "KeyR", "f-index", "L"], ["T", "KeyT", "f-index", "L"],
                        ["Y", "KeyY", "f-index", "R"], ["U", "KeyU", "f-index", "R"], ["I", "KeyI", "f-middle", "R"], ["O", "KeyO", "f-ring", "R"], ["P", "KeyP", "f-pinky", "R"], ["[", "BracketLeft", "f-pinky", "R"], ["]", "BracketRight", "f-pinky", "R"], ["\\", "Backslash", "f-pinky", "R"]
                    ],
                    [
                        ["Caps", "CapsLock", "k-caps f-pinky", "L"], ["A", "KeyA", "f-pinky", "L"], ["S", "KeyS", "f-ring", "L"], ["D", "KeyD", "f-middle", "L"], ["F", "KeyF", "f-index", "L"], ["G", "KeyG", "f-index", "L"],
                        ["H", "KeyH", "f-index", "R"], ["J", "KeyJ", "f-index", "R"], ["K", "KeyK", "f-middle", "R"], ["L", "KeyL", "f-ring", "R"], [";", "Semicolon", "f-pinky", "R"], ["'", "Quote", "f-pinky", "R"], ["Enter", "Enter", "k-enter f-pinky", "R"]
                    ],
                    [
                        ["Shift", "ShiftLeft", "k-shift f-pinky", "L"], ["Z", "KeyZ", "f-pinky", "L"], ["X", "KeyX", "f-ring", "L"], ["C", "KeyC", "f-middle", "L"], ["V", "KeyV", "f-index", "L"], ["B", "KeyB", "f-index", "L"],
                        ["N", "KeyN", "f-index", "R"], ["M", "KeyM", "f-index", "R"], [",", "Comma", "f-middle", "R"], [".", "Period", "f-ring", "R"], ["/", "Slash", "f-pinky", "R"], ["Shift", "ShiftRight", "k-shift f-pinky", "R"]
                    ],
                    [
                        ["Space", "Space", "k-space f-thumb", ""]
                    ]
                ];

                this.highScore = localStorage.getItem('kidsTypeHighScore') || 0;
                this.levelProgress = JSON.parse(localStorage.getItem('kidsTypeProgress')) || {};

                document.getElementById('menu-highscore').innerText = this.highScore;

                this.initKeyboard();
                this.renderMenu();
                this.bindEvents();
            }

            renderMenu() {
                // 1. Drills
                const drillContainer = document.getElementById('drills-container');
                drillContainer.innerHTML = '';
                this.drills.forEach((drill, idx) => {
                    const card = document.createElement('div');
                    card.className = 'drill-card';
                    card.innerHTML = `<h3>${drill.name}</h3><p>${drill.chars.substring(0, 10)}...</p>`;
                    card.onclick = () => this.startMode('drill', idx);
                    drillContainer.appendChild(card);
                });

                // 2. Adventure Levels
                const levelContainer = document.getElementById('levels-container');
                levelContainer.innerHTML = '';
                this.adventureLevels.forEach((lvl, idx) => {
                    const stars = this.levelProgress[lvl.id] || 0;
                    let starHtml = '';
                    for (let i = 0; i < 3; i++) starHtml += `<span class="star ${i < stars ? 'filled' : ''}">‚òÖ</span>`;

                    const card = document.createElement('div');
                    card.className = 'level-card';
                    card.innerHTML = `
                        <div class="level-num">${lvl.id}</div>
                        <div class="level-name">${lvl.icon} ${lvl.name}</div>
                        <div class="stars">${starHtml}</div>
                    `;
                    card.onclick = () => this.startMode('adventure', idx);
                    levelContainer.appendChild(card);
                });
            }

            initKeyboard() {
                const kb = document.getElementById('keyboard');
                kb.innerHTML = '';
                this.keyLayout.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'row';
                    row.forEach(k => {
                        const keyDiv = document.createElement('div');
                        keyDiv.className = `key ${k[2]} `;
                        keyDiv.innerText = k[0];
                        keyDiv.dataset.code = k[1];
                        keyDiv.dataset.hand = k[3];
                        rowDiv.appendChild(keyDiv);
                    });
                    kb.appendChild(rowDiv);
                });
            }

            bindEvents() {
                document.addEventListener('keydown', (e) => {
                    if (!this.isPlaying) return;
                    e.preventDefault();
                    this.handleInput(e);
                });

                document.addEventListener('keyup', (e) => {
                    const keyDiv = document.querySelector(`.key[data-code="${e.code}"]`);
                    if (keyDiv) keyDiv.classList.remove('active');
                });

                document.getElementById('mute-btn').addEventListener('click', (e) => {
                    this.soundEnabled = !this.soundEnabled;
                    e.target.innerText = this.soundEnabled ? "üîä Sound On" : "üîá Sound Off";
                });
            }

            playSound(type) {
                if (!this.soundEnabled) return;

                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!this.audioCtx) this.audioCtx = new AudioContext();
                if (this.audioCtx.state === 'suspended') this.audioCtx.resume();

                const ctx = this.audioCtx;
                const t = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'correct') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, t);
                    osc.frequency.exponentialRampToValueAtTime(300, t + 0.05);
                    gain.gain.setValueAtTime(0.15, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    osc.start(t);
                    osc.stop(t + 0.055);
                } else if (type === 'error') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(100, t);
                    osc.frequency.linearRampToValueAtTime(50, t + 0.1);
                    gain.gain.setValueAtTime(0.2, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                    osc.start(t);
                    osc.stop(t + 0.11);
                } else if (type === 'win') {
                    [500, 600, 700, 800].forEach((freq, i) => {
                        const o = ctx.createOscillator();
                        const g = ctx.createGain();
                        o.connect(g);
                        g.connect(ctx.destination);
                        o.type = 'sine';
                        o.frequency.value = freq;
                        g.gain.setValueAtTime(0.1, t + i * 0.08);
                        g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.08 + 0.1);
                        o.start(t + i * 0.08);
                        o.stop(t + i * 0.08 + 0.11);
                    });
                }
            }

            showMenu() {
                this.isPlaying = false;
                clearInterval(this.timerInterval);
                document.getElementById('menu-screen').classList.add('active');
                document.getElementById('game-screen').classList.remove('active');
                document.getElementById('result-modal').classList.remove('active');
                this.renderMenu(); // Refresh for stars
            }

            startMode(mode, index = 0) {
                this.currentMode = mode;
                this.currentLevelIndex = index;
                document.getElementById('menu-screen').classList.remove('active');
                document.getElementById('game-screen').classList.add('active');
                this.resetGame();
            }

            nextLevel() {
                if (this.currentMode === 'adventure' && this.currentLevelIndex < this.adventureLevels.length - 1) {
                    this.startMode('adventure', this.currentLevelIndex + 1);
                }
                document.getElementById('result-modal').classList.remove('active');
            }

            retry() {
                document.getElementById('result-modal').classList.remove('active');
                this.resetGame();
            }

            showToast(message, duration = 3000) {
                const toast = document.getElementById('toast');
                toast.innerText = message;
                toast.classList.add('show');

                // Clear existing timeout if any
                if (this.toastTimeout) clearTimeout(this.toastTimeout);

                this.toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            resetGame() {
                this.score = 0;
                this.currentIndex = 0;
                this.isPlaying = true;
                this.timer = 0; // Default count up

                // Reset Scroll
                const displayArea = document.getElementById('display-area');
                if (displayArea) displayArea.scrollTop = 0;

                // Content Generation
                if (this.currentMode === 'drill') {
                    this.text = this.generateLessonText(this.drills[this.currentLevelIndex].content);
                    document.getElementById('level-name').innerText = this.drills[this.currentLevelIndex].name;
                }
                else if (this.currentMode === 'adventure') {
                    // Convert word list to lines
                    const rawWordsArray = this.adventureLevels[this.currentLevelIndex].words;
                    this.text = this.formatWordsToText(rawWordsArray);
                    document.getElementById('level-name').innerText = this.adventureLevels[this.currentLevelIndex].name;
                }
                else if (this.currentMode === 'game') {
                    this.text = this.generateRandomWords(50);
                    document.getElementById('level-name').innerText = "Star Rush";
                    this.timer = 60; // Count down
                }

                this.renderText();
                this.updateStats();
                this.highlightNextKey();

                // Timer Logic
                clearInterval(this.timerInterval);
                if (this.currentMode === 'game') {
                    this.timerInterval = setInterval(() => {
                        this.timer--;
                        this.updateStats();
                        if (this.timer <= 0) this.endGame();
                    }, 1000);
                } else {
                    this.timerInterval = setInterval(() => {
                        this.timer++;
                        this.updateStats();
                    }, 1000);
                }
            }

            // Helpers to format text consistently
            generateLessonText(seed) {
                if (seed.includes('\n')) return seed;
                let result = seed;
                while (result.length < 50) result += " " + seed;
                return result.substring(0, 100);
            }

            formatWordsToText(originalArray) {
                // Shuffle Array Items - clone first to not mutate original
                let items = [...originalArray].sort(() => Math.random() - 0.5);

                // Ensure enough content for 3 lines by repeating if needed
                while (items.length < 30) {
                    items = items.concat(items);
                }

                let lines = [];
                let currentLine = [];
                const LINE_LENGTH = 42; // Reduced further to prevent enter char overflow

                for (let w of items) {
                    if (lines.length >= 3) break; // Limit to 3 lines

                    if (currentLine.join(' ').length + w.length > LINE_LENGTH) {
                        lines.push(currentLine.join(' '));
                        currentLine = [];
                        if (lines.length >= 3) break;
                    }
                    currentLine.push(w);
                }

                // If we finished words but haven't filled 3 lines, add the last partial line
                if (currentLine.length > 0 && lines.length < 3) {
                    lines.push(currentLine.join(' '));
                }

                // If still less than 3 lines, padding
                while (lines.length < 3) {
                    lines.push(lines[0] || "practice typing");
                }

                return lines.join('\n');
            }

            generateRandomWords(count) {
                // Collect all single words from levels 1-18 (exclude multi-word levels: Book Titles, Phrases, Sentences)
                let allWords = [];
                const singleWordLevelCount = 18;
                for (let i = 0; i < singleWordLevelCount; i++) {
                    allWords = allWords.concat(this.adventureLevels[i].words);
                }
                // Add simple words too
                allWords = allWords.concat(this.simpleWords);

                let res = [];
                for (let i = 0; i < count; i++) {
                    res.push(allWords[Math.floor(Math.random() * allWords.length)]);
                }
                let lines = [];
                while (res.length > 0) lines.push(res.splice(0, 6).join(" "));
                return lines.join("\n");
            }

            renderText() {
                const container = document.getElementById('display-area');
                container.innerHTML = '';

                this.text.split('').forEach((char, i) => {
                    if (char === '\n') {
                        const enterSpan = document.createElement('span');
                        enterSpan.className = 'char enter-char pending';
                        if (i === 0) enterSpan.classList.add('current');
                        container.appendChild(enterSpan);
                        container.appendChild(document.createElement('br'));
                    } else {
                        const span = document.createElement('span');
                        span.innerText = char;
                        span.className = 'char pending';
                        if (char === ' ') {
                            span.innerHTML = '&nbsp;';
                            span.classList.add('space-char');
                        }
                        if (i === 0) span.classList.add('current');
                        container.appendChild(span);
                    }
                });
            }

            handleInput(e) {
                if (e.key === 'Shift' || e.key === 'CapsLock' || e.key === 'Alt' || e.key === 'Control') return;

                const keyDiv = document.querySelector(`.key[data-code="${e.code}"]`);
                if (keyDiv) keyDiv.classList.add('active');

                const requiredChar = this.text[this.currentIndex];
                const displayElements = document.getElementById('display-area').querySelectorAll('.char');

                const isEnglishChar = /^[ -~]$/.test(e.key);
                const isControlKey = e.key.length > 1;

                if (!isEnglishChar && !isControlKey) {
                    this.showToast("‚ö†Ô∏è Please switch input source to English!");
                    return;
                }

                let isCorrect = false;

                if (requiredChar === '\n') {
                    if (e.key === 'Enter') isCorrect = true;
                } else {
                    if (e.key === requiredChar) isCorrect = true;
                }

                if (isCorrect) {
                    this.playSound('correct');
                    if (displayElements[this.currentIndex]) {
                        displayElements[this.currentIndex].className = requiredChar === '\n' ? 'char enter-char correct' : 'char correct';
                        if (requiredChar === ' ') displayElements[this.currentIndex].classList.add('space-char');
                    }

                    this.currentIndex++;
                    this.score += 10;

                    if (this.currentIndex >= this.text.length) {
                        if (this.currentMode === 'game') {
                            // Endless mode logic
                            const newWords = "\n" + this.generateRandomWords(5);
                            this.text += newWords;
                            const container = document.getElementById('display-area');
                            newWords.split('').forEach(char => {
                                if (char === '\n') {
                                    const s = document.createElement('span'); s.className = 'char enter-char pending'; container.appendChild(s);
                                    container.appendChild(document.createElement('br'));
                                } else {
                                    const s = document.createElement('span'); s.innerText = char; s.className = 'char pending';
                                    if (char === ' ') { s.innerHTML = '&nbsp;'; s.classList.add('space-char'); }
                                    container.appendChild(s);
                                }
                            });
                            container.scrollTop = container.scrollHeight;
                        } else {
                            this.endGame();
                            return;
                        }
                    }

                    const nextEl = document.getElementById('display-area').querySelectorAll('.char')[this.currentIndex];
                    if (nextEl) {
                        nextEl.classList.add('current');
                        nextEl.scrollIntoView({ behavior: "smooth", block: "center" });
                        this.highlightNextKey();
                    }
                } else {
                    this.playSound('error');
                    if (displayElements[this.currentIndex]) {
                        displayElements[this.currentIndex].classList.add('incorrect');
                    }
                    this.score = Math.max(0, this.score - 5);
                }
                this.updateStats();
            }

            highlightNextKey() {
                document.querySelectorAll('.key.target').forEach(k => k.classList.remove('target'));
                document.getElementById('hand-left').classList.remove('active');
                document.getElementById('hand-right').classList.remove('active');
                document.getElementById('finger-name-left').innerText = "";
                document.getElementById('finger-name-right').innerText = "";

                if (this.currentIndex >= this.text.length) return;

                const char = this.text[this.currentIndex];
                let code = '';

                if (char === '\n') code = 'Enter';
                else code = this.getKeyCode(char);

                const keyDiv = document.querySelector(`.key[data-code="${code}"]`);
                if (keyDiv) {
                    keyDiv.classList.add('target');
                    const hand = keyDiv.dataset.hand;

                    // Determine Finger Name and Color
                    let fingerName = "";
                    let fingerColorVar = "";

                    if (keyDiv.classList.contains('f-pinky')) { fingerName = "Pinky"; fingerColorVar = "var(--f-pinky)"; }
                    else if (keyDiv.classList.contains('f-ring')) { fingerName = "Ring"; fingerColorVar = "var(--f-ring)"; }
                    else if (keyDiv.classList.contains('f-middle')) { fingerName = "Middle"; fingerColorVar = "var(--f-middle)"; }
                    else if (keyDiv.classList.contains('f-index')) { fingerName = "Index"; fingerColorVar = "var(--f-index)"; }
                    else if (keyDiv.classList.contains('f-thumb')) { fingerName = "Thumb"; fingerColorVar = "var(--f-thumb)"; }

                    if (hand === 'L') {
                        document.getElementById('hand-left').classList.add('active');
                        const el = document.getElementById('finger-name-left');
                        el.innerText = ": " + fingerName;
                        el.style.color = fingerColorVar;
                    }
                    if (hand === 'R') {
                        document.getElementById('hand-right').classList.add('active');
                        const el = document.getElementById('finger-name-right');
                        el.innerText = fingerName + " :";
                        el.style.color = fingerColorVar;
                    }

                    if (code === 'Space') {
                        document.getElementById('hand-left').classList.add('active');
                        document.getElementById('hand-right').classList.add('active');

                        const elLeft = document.getElementById('finger-name-left');
                        elLeft.innerText = ": Thumb";
                        elLeft.style.color = "var(--f-thumb)";

                        const elRight = document.getElementById('finger-name-right');
                        elRight.innerText = "Thumb :";
                        elRight.style.color = "var(--f-thumb)";
                    }

                    if (char && char.match(/[A-Z!@#$%^&*()_+{}:"<>?]/)) {
                        const shiftKey = document.querySelector('.key[data-code="ShiftLeft"]');
                        if (shiftKey) shiftKey.classList.add('target');
                    }
                }
            }

            getKeyCode(char) {
                if (char === ' ') return 'Space';
                if (char === ';') return 'Semicolon';
                if (char === ',') return 'Comma';
                if (char === '.') return 'Period';
                if (char === '/') return 'Slash';
                if (char.toUpperCase() >= 'A' && char.toUpperCase() <= 'Z') return 'Key' + char.toUpperCase();
                if (!isNaN(parseInt(char))) return 'Digit' + char;
                return '';
            }

            updateStats() {
                document.getElementById('score').innerText = this.score;
                document.getElementById('timer').innerText = this.currentMode === 'game' ? this.timer + 's' : this.formatTime(this.timer);
            }

            formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m}:${sec.toString().padStart(2, '0')} `;
            }

            endGame() {
                this.isPlaying = false;
                clearInterval(this.timerInterval);
                this.playSound('win');

                // Calculate Stats
                let timeSpent = 0;
                if (this.currentMode === 'game') {
                    timeSpent = 60 - this.timer;
                } else {
                    timeSpent = this.timer;
                }
                if (timeSpent < 1) timeSpent = 1;

                // Standard WPM: (Chars / 5) / Minutes
                // Avoid infinite if very fast
                const minutes = timeSpent / 60;
                const wpm = Math.round((this.currentIndex / 5) / minutes);

                let starsEarned = 0;

                // Star Logic
                if (this.currentMode === 'adventure') {
                    starsEarned = 3;

                    // Save
                    const lvlId = this.adventureLevels[this.currentLevelIndex].id;
                    const oldStars = this.levelProgress[lvlId] || 0;
                    if (starsEarned > oldStars) {
                        this.levelProgress[lvlId] = starsEarned;
                        localStorage.setItem('kidsTypeProgress', JSON.stringify(this.levelProgress));
                    }
                }

                // High Score for game mode
                if (this.currentMode === 'game' && this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('kidsTypeHighScore', this.highScore);
                    document.getElementById('menu-highscore').innerText = this.highScore;
                }

                // Show Modal
                document.getElementById('result-score').innerText = this.score;
                document.getElementById('result-wpm').innerText = `WPM: ${wpm} `;

                const starsDiv = document.getElementById('result-stars');
                starsDiv.innerHTML = '';
                if (this.currentMode === 'adventure') {
                    for (let i = 0; i < 3; i++) {
                        starsDiv.innerHTML += `<span style = "color: ${i < starsEarned ? '#fbbf24' : '#ccc'}" >‚òÖ</span> `;
                    }
                }

                // Next Level Button Logic
                const nextBtn = document.getElementById('btn-next-level');
                if (this.currentMode === 'adventure' && this.currentLevelIndex < this.adventureLevels.length - 1) {
                    nextBtn.style.display = 'block';
                    nextBtn.onclick = () => this.nextLevel();
                } else {
                    nextBtn.style.display = 'none';
                }

                document.getElementById('result-modal').classList.add('active');

                // Confetti
                for (let i = 0; i < 50; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.animationDuration = Math.random() * 2 + 2 + 's';
                    c.style.backgroundColor = `hsl(${Math.random() * 360}, 100 %, 50 %)`;
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }
            }
        }

        const app = new TypingApp();
    </script>
</body>

</html>